name: Production Deployment
on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Production Deployment
        uses: dawidd6/action-ansible-playbook@v7
        with:
          directory: ./scripts/playbooks/production
          playbook: deploy.yml
          inventory: |
            [debian_servers]
            dianalu.design ansible_user=admin
          key: ${{ secrets.PRODUCTION_PRIVATE_KEY }}

      - name: Wait for DianaLÃº CMS to be ready
        uses: gerdemann/http-status-code@1.0.0
        with:
          url: 'https://dianalu.design/admin'
          code: 200
          timeout: 240
          interval: 10
