---
- name: Deploy DianaLÃº
  hosts: ec2-34-228-89-155.compute-1.amazonaws.com
  become: false

  tasks:
    - name: Pull latest code from production
      shell: git pull origin production
      args:
        chdir: ~/dianalu.design

    - name: Rebuild app
      shell: >
        docker compose exec app bun run build ||
        docker run --rm -v $(pwd)/app:/app -w /app oven/bun:1.3-debian
        bash -c "bun i && bun run build"
      args:
        chdir: ~/dianalu.design

    - name: Rebuild cms
      shell: >
        docker compose exec cms bun run build ||
        docker run --rm -v $(pwd)/cms:/app -w /app oven/bun:1.3-debian
        bash -c "bun i && bun run build"
      args:
        chdir: ~/dianalu.design

    - name: Stop existing screen session
      shell: screen -S dianalu.design -X quit
      ignore_errors: true

    - name: Stop docker containers
      shell: make production-stop
      ignore_errors: true
      args:
        chdir: ~/dianalu.design

    - name: Start screen session with make production
      shell: screen -dmS dianalu.design make production
      args:
        chdir: ~/dianalu.design
